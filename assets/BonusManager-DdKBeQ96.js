var l=(c,e,t)=>new Promise((a,n)=>{var s=r=>{try{o(t.next(r))}catch(d){n(d)}},i=r=>{try{o(t.throw(r))}catch(d){n(d)}},o=r=>r.done?a(r.value):Promise.resolve(r.value).then(s,i);o((t=t.apply(c,e)).next())});class u{constructor(){this.isActive=!1,this.isAdShowing=!1,this.ticksUntilAd=0,this.playerCaravanAmount=0,this.enemyCaravanAmount=0,this.isAdAvailable=!1}decrementTimer(){this.ticksUntilAd>0&&this.ticksUntilAd--}resetTimer(e){this.ticksUntilAd=e}isTimeForActivation(e){return this.ticksUntilAd<=e&&this.ticksUntilAd>0&&!this.isActive}isTimeExpired(){return this.ticksUntilAd<=0}getSecondsLeft(){return Math.floor(this.ticksUntilAd/50)}addCaravanResources(e,t){this.playerCaravanAmount+=e,this.enemyCaravanAmount+=t}resetCaravanResources(){this.playerCaravanAmount=0,this.enemyCaravanAmount=0}getPlayerReserves(){return Math.floor(this.playerCaravanAmount)}getEnemyReserves(){return Math.floor(this.enemyCaravanAmount)}activate(){this.isActive=!0}deactivate(){this.isActive=!1}setAdAvailability(e){this.isAdAvailable=e}getState(){return{ticksUntilAd:this.ticksUntilAd,playerCaravanAmount:this.playerCaravanAmount,enemyCaravanAmount:this.enemyCaravanAmount,isActive:this.isActive,isAdAvailable:this.isAdAvailable}}loadState(e){e&&(this.ticksUntilAd=e.ticksUntilAd||0,this.playerCaravanAmount=e.playerCaravanAmount||0,this.enemyCaravanAmount=e.enemyCaravanAmount||0,this.isActive=!1,this.isAdAvailable=e.isAdAvailable||!1)}}class g{constructor(e,t){this.gameEngine=e,this.renderer=t,this.AD_INTERVAL_TICKS=180*50,this.AD_ACTIVATION_BEFORE_TICKS=10*50,this.REINFORCEMENT_BLINK_DURATION=2e3,this.adState=new u,this.resetState(),this.init()}resetState(){this.adState.isActive=!1,this.adState.isAdShowing=!1,this.adState.ticksUntilAd=this.AD_INTERVAL_TICKS,this.adState.playerCaravanAmount=0,this.adState.enemyCaravanAmount=0,this.adState.isAdAvailable=!1,this.isShowingModal=!1,this.adButton=document.getElementById("caravanAdButton"),this.reinforcementBlinkInterval=null}init(){console.log("üéØ BonusManager: init() - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã"),this.adButton.addEventListener("click",()=>this.handleAdClick()),document.addEventListener("langChanged",()=>{this.updateLocalization()})}isRewardedAdAvailable(){var e,t,a;try{return(a=(t=(e=window.gp)==null?void 0:e.ads)==null?void 0:t.isRewardedAvailable)!=null?a:!1}catch(n){return console.error("üéØ BonusManager: –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä–µ–∫–ª–∞–º—ã:",n),!1}}pauseGameForInterruption(e){var a;if(!((a=this.gameEngine)!=null&&a.state))return null;console.log(`üéØ BonusManager: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –ø–µ—Ä–µ–¥ ${e}:`);const t={speed:this.gameEngine.state.speed};return this.gameEngine.state.speed=0,t}resumeGameAfterInterruption(e,t){var a;!((a=this.gameEngine)!=null&&a.state)||!e||(console.log(`üéØ BonusManager: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã –ø–æ—Å–ª–µ ${t}:`,e),this.gameEngine.state.speed=e.speed)}getTranslations(){const e=document.documentElement.lang||"en",t=document.getElementById("i18n"),{[e]:a={},en:n={}}=JSON.parse(t.textContent);return new Proxy(a.sidebarText||{},{get:(s,i)=>{var o;return s[i]||((o=n.sidebarText)==null?void 0:o[i])||i}})}updateLocalization(){const e=document.documentElement.lang||"en",t=document.getElementById("i18n");if(!(t!=null&&t.textContent)||!this.adButton)return;const{[e]:{sidebarText:a={}}={}}=JSON.parse(t.textContent);if(!(a!=null&&a.watchAd))return;this.adButton.querySelectorAll("[data-en]").forEach(s=>{s.tagName==="SPAN"&&(s.textContent=a.watchAd),s.setAttribute(`data-${e}`,a.watchAd)})}getState(){return this.adState.getState()}loadState(e){this.adState.loadState(e),e?console.log(`üéØ BonusManager: –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ - —Ç–∏–∫–æ–≤ –¥–æ —Ä–µ–∫–ª–∞–º—ã: ${this.adState.ticksUntilAd}`):(this.adState.ticksUntilAd=this.AD_INTERVAL_TICKS,console.log(`üéØ BonusManager: –ù–æ–≤–∞—è –∏–≥—Ä–∞ - —Ç–∏–∫–æ–≤ –¥–æ —Ä–µ–∫–ª–∞–º—ã: ${this.adState.ticksUntilAd}`)),this.updateTruckPosition()}update(){var e;!((e=this.gameEngine)!=null&&e.state)||this.adState.isAdShowing||this.isShowingModal||(this.gameEngine.state.speed>0&&(this.adState.decrementTimer(),this.accumulateCaravanResources()),this.updateTruckPosition(),this.logDebugInfo(),this.updateButtonState(),this.checkCaravanTimeout(),this.adState.isActive&&this.updateTimerDisplay())}logDebugInfo(){if(this.adState.ticksUntilAd%50===0){const e=this.adState.getSecondsLeft();console.log(`üéØ BonusManager: –î–æ –∫–∞—Ä–∞–≤–∞–Ω–∞ ${e}—Å, –Ω–∞–∫–æ–ø–ª–µ–Ω–æ - –ò–≥—Ä–æ–∫: ${this.adState.getPlayerReserves()}, –ò–ò: ${this.adState.getEnemyReserves()}`)}}updateButtonState(){const e=this.adState.ticksUntilAd<=this.AD_ACTIVATION_BEFORE_TICKS&&this.adState.ticksUntilAd>0&&!this.isShowingModal;e&&!this.adState.isActive?(this.adState.setAdAvailability(this.isRewardedAdAvailable()),console.log(`üéØ BonusManager: –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∑–∞ ${this.adState.getSecondsLeft()} —Å–µ–∫—É–Ω–¥ –¥–æ –ø—Ä–∏–±—ã—Ç–∏—è –∫–∞—Ä–∞–≤–∞–Ω–∞, —Ä–µ–∫–ª–∞–º–∞ –¥–æ—Å—Ç—É–ø–Ω–∞: ${this.adState.isAdAvailable}`),this.activateAdButton()):!e&&this.adState.isActive&&(console.log("üéØ BonusManager: –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É - —É—Å–ª–æ–≤–∏–µ –±–æ–ª—å—à–µ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è"),this.deactivateAdButtonSilently())}checkCaravanTimeout(){this.adState.isTimeExpired()&&this.handleAdTimeout()}updateTruckPosition(){if(!this.adButton)return;const e=this.AD_INTERVAL_TICKS,n=(1-Math.max(0,Math.min(this.adState.ticksUntilAd/e*100,100))/100)*90;this.adButton.style.setProperty("--timer-offset",`${n}%`)}accumulateCaravanResources(){var n,s;if(!((s=(n=this.gameEngine)==null?void 0:n.state)!=null&&s.resources))return;const e=this.gameEngine.state.resources,t=this.gameEngine.state.speed,a=1/50;if(t>0&&e.adRewardPlayerRate>=0&&e.adRewardEnemyRate>=0){const i=.15*e.adRewardPlayerRate*a,o=.15*e.adRewardEnemyRate*a*Math.max(1,t);this.adState.addCaravanResources(i,o)}}scheduleNextAd(){this.adState.resetTimer(this.AD_INTERVAL_TICKS),console.log(`üéØ BonusManager: –°–ª–µ–¥—É—é—â–∏–π –∫–∞—Ä–∞–≤–∞–Ω —á–µ—Ä–µ–∑ ${Math.floor(this.AD_INTERVAL_TICKS/50)} —Å–µ–∫—É–Ω–¥`)}activateAdButton(){console.log("üéØ BonusManager: activateAdButton() - –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å —Ç–∞–π–º–µ—Ä–æ–º"),this.adState.activate(),this.adButton&&(this.adButton.disabled=!1,this.adButton.classList.add("active"),this.adButton.classList.add("timer-active"),this.adState.isAdAvailable?(this.adButton.classList.remove("unavailable"),this.updateButtonText("available")):(this.adButton.classList.add("unavailable"),this.updateButtonText("unavailable")),this.createTimerElement())}updateButtonText(e){var n;const t=(n=this.adButton)==null?void 0:n.querySelector("span[data-en]");if(!t)return;const a=document.documentElement.lang||"en";if(e==="available"){const s={en:"Plunder for ad",ru:"–ì—Ä–∞–±–∏—Ç—å –∑–∞ —Ä–µ–∫–ª–∞–º—É"};t.textContent=s[a]||s.en}else{const s={en:"Agents lost contact",ru:"–ù–µ—Ç —Å–≤—è–∑–∏ —Å –∞–≥–µ–Ω—Ç–∞–º–∏"};t.textContent=s[a]||s.en}}createTimerElement(){let e=this.adButton.querySelector(".caravan-timer");e||(e=document.createElement("div"),e.className="caravan-timer",this.adButton.appendChild(e))}updateTimerDisplay(){var a;const e=(a=this.adButton)==null?void 0:a.querySelector(".caravan-timer");if(!e)return;const t=Math.ceil(this.adState.ticksUntilAd/50);e.textContent=t,t<=0&&e.remove()}deactivateAdButtonSilently(){if(this.adState.deactivate(),this.adButton){this.adButton.disabled=!0,this.adButton.classList.remove("active"),this.adButton.classList.remove("timer-active"),this.adButton.classList.remove("unavailable");const e=this.adButton.querySelector(".caravan-timer");e&&e.remove()}}deactivateAdButton(){this.deactivateAdButtonSilently(),this.scheduleNextAd(),console.log("üéØ BonusManager: –ö–Ω–æ–ø–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞, –≥—Ä—É–∑–æ–≤–∏–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç –¥–≤–∏–∂–µ–Ω–∏–µ")}handleAdTimeout(){console.log("üéØ BonusManager: –±–æ–Ω—É—Å –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä"),this.deactivateAdButton(),this.giveEnemyReserves()}handleAdClick(){return l(this,null,function*(){var t;if(!this.adState.isActive||this.isShowingModal)return;if(!this.adState.isAdAvailable||!this.isRewardedAdAvailable()){this.showAgentsLostMessage();return}if((t=this.renderer)!=null&&t.bonusManagerLoadError||!this.isAdServiceAvailable()){this.showAgentsLostMessage();return}const e=yield this.showRewardedVideo();this.processAdResult(e)})}isAdServiceAvailable(){return typeof window.gp!="undefined"&&window.gp.ads}processAdResult(e){if(e){this.deactivateAdButton();const t=e===!0?1:e||0;this.givePlayerReserves(t)}else console.log("üéØ BonusManager: –†–µ–∫–ª–∞–º–∞ –Ω–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–∞ - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ —Ç–∞–π–º-–∞—É—Ç"),this.handleAdTimeout()}showRewardedVideo(){return l(this,null,function*(){this.adState.isAdShowing=!0;try{const e=this.pauseGameForInterruption("–ø–æ–∫–∞–∑–æ–º —Ä–µ–∫–ª–∞–º—ã"),t=yield this.tryShowRewardedVideo();return this.resumeGameAfterInterruption(e,"—Ä–µ–∫–ª–∞–º—ã"),t}catch(e){return console.error("üéØ BonusManager: –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ —Ä–µ–∫–ª–∞–º—ã:",e),!1}finally{this.adState.isAdShowing=!1,console.log("üéØ BonusManager: –ü–æ–∫–∞–∑ —Ä–µ–∫–ª–∞–º—ã –∑–∞–≤–µ—Ä—à–µ–Ω, isAdShowing = false")}})}tryShowRewardedVideo(){return l(this,null,function*(){if(!this.isAdServiceAvailable())return console.warn("‚ö†Ô∏è BonusManager: GamePush SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω - –≤–æ–∑–º–æ–∂–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"),!1;try{if(console.log("üéØ BonusManager: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º REWARDED VIDEO —Ä–µ–∫–ª–∞–º—É —á–µ—Ä–µ–∑ GamePush API (–∑–∞ –Ω–∞–≥—Ä–∞–¥—É)"),window.gp.ads.isRewardedAvailable)return console.log("‚úÖ BonusManager: Rewarded —Ä–µ–∫–ª–∞–º–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º"),yield window.gp.ads.showRewardedVideo(),console.log("‚úÖ BonusManager: REWARDED VIDEO —Ä–µ–∫–ª–∞–º–∞ GamePush –ø–æ–∫–∞–∑–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ"),!0;throw console.warn("‚ö†Ô∏è BonusManager: Rewarded —Ä–µ–∫–ª–∞–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ (–Ω–µ—Ç –∫–∞–º–ø–∞–Ω–∏–π/–µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è)"),new Error("Rewarded —Ä–µ–∫–ª–∞–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞")}catch(e){return console.error("‚ùå BonusManager: –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ REWARDED VIDEO —Ä–µ–∫–ª–∞–º—ã GamePush:",e),console.log("üéØ BonusManager: –†–µ–∞–ª—å–Ω–∞—è —Ä–µ–∫–ª–∞–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ - –Ω–∞–≥—Ä–∞–¥–∞ –Ω–µ –≤—ã–¥–∞–µ—Ç—Å—è"),!1}})}showAgentsLostMessage(){if(this.isShowingModal||document.querySelector(".bonus-blocked-modal"))return;this.isShowingModal=!0,this.adState.deactivate();const e=this.pauseGameForInterruption("–ø–æ–∫–∞–∑–æ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ä–∞–∑–≤–µ–¥–∫–∏"),t=document.createElement("div");t.className="bonus-blocked-modal";const a=this.getTranslations(),n=document.documentElement.lang||"en",i={en:{title:"Intelligence Network Down",message:"Our intelligence network lost contact with field agents. Caravan interception is temporarily impossible.",reason:"This might be due to an ad blocker, communication issues, or simply because no intel (ads) is available."},ru:{title:"–°–µ—Ç—å –∞–≥–µ–Ω—Ç–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞",message:"–†–∞–∑–≤–µ–¥–∫–∞ –ø–æ—Ç–µ—Ä—è–ª–∞ —Å–≤—è–∑—å —Å –ø–æ–ª–µ–≤—ã–º–∏ –∞–≥–µ–Ω—Ç–∞–º–∏. –ü–µ—Ä–µ—Ö–≤–∞—Ç –∫–∞—Ä–∞–≤–∞–Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.",reason:"–≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω–æ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π —Ä–µ–∫–ª–∞–º—ã, –ø–æ–º–µ—Ö–∞–º–∏ —Å–≤—è–∑–∏ –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º —Ä–∞–∑–≤–µ–¥–¥–∞–Ω–Ω—ã—Ö (—Ä–µ–∫–ª–∞–º—ã)."}}[n];t.innerHTML=`
      <div class="bonus-blocked-modal-content">
        <h3>${i.title}</h3></br>
        <p>${i.message}</p></br>
        <p>${i.reason}</p></br>
        <button id="agentsLostOk" class="bonus-blocked-btn">${a.ok}</button>
      </div>
    `,document.body.appendChild(t);const o=()=>{this.isShowingModal=!1,this.resumeGameAfterInterruption(e,"–∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞"),document.body.removeChild(t)};t.querySelector("#agentsLostOk").addEventListener("click",o),t.addEventListener("click",d=>{d.target===t&&o()})}givePlayerReserves(e=1){const t=this.gameEngine.state,a=this.adState.getPlayerReserves(),n=Math.floor(a*e);t.resources.player+=n;let s="";e>=1?s="–ø–æ–ª–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞":e>=.5?s="–ø–æ–ª–æ–≤–∏–Ω–∞ –Ω–∞–≥—Ä–∞–¥—ã":s="–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞",console.log(`üéØ BonusManager: –ò–≥—Ä–æ–∫ –ø–æ–ª—É—á–∏–ª ${n}/${a} —Ä–µ–∑–µ—Ä–≤–æ–≤ (${s})`),this.adState.resetCaravanResources(),this.blinkReserves("player")}giveEnemyReserves(){const e=this.gameEngine.state,t=this.adState.getEnemyReserves();e.resources.enemy+=t,console.log(`üéØ BonusManager: –ö–æ–º–ø—å—é—Ç–µ—Ä –ø–æ–ª—É—á–∏–ª ${t} —Ä–µ–∑–µ—Ä–≤–æ–≤ (–∏–≥—Ä–æ–∫ –Ω–µ –ø–æ—Å–º–æ—Ç—Ä–µ–ª —Ä–µ–∫–ª–∞–º—É)`),this.adState.resetCaravanResources(),this.blinkReserves("enemy")}blinkReserves(e){const t=e==="player"?document.getElementById("playerReserve"):document.getElementById("enemyReserve");if(!t)return;const a=e==="player"?"#00ff00":"#ff0000",n=t.style.backgroundColor,s=t.style.opacity;let i=0;const o=8;this.reinforcementBlinkInterval=setInterval(()=>{i++,i%2===0?(t.style.backgroundColor=a,t.style.opacity="1"):(t.style.backgroundColor="transparent",t.style.opacity="0.7"),i>=o&&(clearInterval(this.reinforcementBlinkInterval),t.style.backgroundColor=n,t.style.opacity=s)},250)}showAd(e){return l(this,null,function*(){this.adState.isAdShowing=!0;try{if(!this.isAdServiceAvailable())return console.warn("‚ö†Ô∏è BonusManager: GamePush SDK –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∫–ª–∞–º—ã"),!1;const a={preloader:{available:window.gp.ads.isPreloaderAvailable,show:()=>window.gp.ads.showPreloader()},fullscreen:{available:window.gp.ads.isFullscreenAvailable,show:()=>window.gp.ads.showFullscreen()},rewarded:{available:window.gp.ads.isRewardedAvailable,show:()=>window.gp.ads.showRewardedVideo()}}[e];return!a||!a.available?(console.warn(`‚ö†Ô∏è BonusManager: ${e} —Ä–µ–∫–ª–∞–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞`),!1):(console.log(`üéØ BonusManager: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º ${e.toUpperCase()} —Ä–µ–∫–ª–∞–º—É —á–µ—Ä–µ–∑ GamePush API`),yield a.show(),console.log(`‚úÖ BonusManager: ${e} —Ä–µ–∫–ª–∞–º–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ`),!0)}catch(t){return console.error(`‚ùå BonusManager: –û—à–∏–±–∫–∞ –ø–æ–∫–∞–∑–∞ ${e} —Ä–µ–∫–ª–∞–º—ã:`,t),!1}finally{this.adState.isAdShowing=!1}})}showPreGameAd(){return l(this,null,function*(){return console.log("üéØ BonusManager: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º PRELOADER —Ä–µ–∫–ª–∞–º—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∏–≥—Ä—ã"),yield this.showAd("preloader")})}showPostGameAd(e=!1){return l(this,null,function*(){return console.log(`üéØ BonusManager: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º FULLSCREEN —Ä–µ–∫–ª–∞–º—É –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏–≥—Ä—ã (–ø–æ–±–µ–¥–∞: ${e})`),yield this.showAd("fullscreen")})}showRewardedAd(){return l(this,null,function*(){return console.log("üéØ BonusManager: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º REWARDED —Ä–µ–∫–ª–∞–º—É"),yield this.showAd("rewarded")})}}export{g as BonusManager};
