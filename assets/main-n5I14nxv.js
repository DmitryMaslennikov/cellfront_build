var X=Object.defineProperty;var q=Object.getOwnPropertySymbols;var Q=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var B=Math.pow,J=(h,e,t)=>e in h?X(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t,z=(h,e)=>{for(var t in e||(e={}))Q.call(e,t)&&J(h,t,e[t]);if(q)for(var t of q(e))Z.call(e,t)&&J(h,t,e[t]);return h};var I=(h,e,t)=>new Promise((s,n)=>{var i=o=>{try{a(t.next(o))}catch(c){n(c)}},r=o=>{try{a(t.throw(o))}catch(c){n(c)}},a=o=>o.done?s(o.value):Promise.resolve(o.value).then(i,r);a((t=t.apply(h,e)).next())});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const i of n)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(n){const i={};return n.integrity&&(i.integrity=n.integrity),n.referrerPolicy&&(i.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?i.credentials="include":n.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(n){if(n.ep)return;n.ep=!0;const i=t(n);fetch(n.href,i)}})();const K="modulepreload",ee=function(h,e){return new URL(h,e).href},j={},te=function(e,t,s){let n=Promise.resolve();if(t&&t.length>0){let r=function(d){return Promise.all(d.map(l=>Promise.resolve(l).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};const a=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),c=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));n=r(t.map(d=>{if(d=ee(d,s),d in j)return;j[d]=!0;const l=d.endsWith(".css"),y=l?'[rel="stylesheet"]':"";if(!!s)for(let u=a.length-1;u>=0;u--){const b=a[u];if(b.href===d&&(!l||b.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${y}`))return;const m=document.createElement("link");if(m.rel=l?"stylesheet":K,l||(m.as="script"),m.crossOrigin="",m.href=d,c&&m.setAttribute("nonce",c),document.head.appendChild(m),l)return new Promise((u,b)=>{m.addEventListener("load",u),m.addEventListener("error",()=>b(new Error(`Unable to preload CSS for ${d}`)))})}))}function i(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return n.then(r=>{for(const a of r||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})},se=12,ne=18,Y={player:5,enemy:5,incomeP:0,incomeE:0};class U{constructor(e=se,t=ne){this.gridSize={rows:e,cols:t},this.grid=this._createEmptyGrid(e,t),this.resources=z({},Y),this.playerRein=0,this.enemyRein=0,this.adRewardPlayerRate=0,this.adRewardEnemyRate=0,this.difficulty=0,this.breath=0,this.reinforcements=0,this.speed=1,this.tickCount=0,this.startPhase=Math.random()*Math.PI*2,this.running=!1,this.RANDOM_RATIO=.005,this.rules=new Map(U.DEFAULT_RULES)}_createEmptyGrid(e,t){return Array.from({length:e},()=>Array(t).fill(0))}reset(){const{rows:e,cols:t}=this.gridSize;this.grid=this._createEmptyGrid(e,t),this.resources=z({},Y),this.playerRein=0,this.enemyRein=0,this.adRewardPlayerRate=0,this.adRewardEnemyRate=0,this.tickCount=0,this.startPhase=Math.random()*Math.PI*2,this.running=!1}countUnits(){let e=0,t=0;const{rows:s,cols:n}=this.gridSize;for(let i=0;i<s;i++)for(let r=0;r<n;r++)this.grid[i][r]===1&&e++,this.grid[i][r]===-1&&t++;return{player:e,enemy:t}}toJSON(){return{difficulty:this.difficulty,breath:this.breath,reinforcements:this.reinforcements,playerRein:this.playerRein,enemyRein:this.enemyRein,gridSize:z({},this.gridSize),grid:this.grid.map(e=>[...e]),resources:z({},this.resources),tickCount:this.tickCount,startPhase:this.startPhase,bonusManagerState:this.bonusManagerState||null}}static fromJSON(e){const t=new U(e.gridSize.rows,e.gridSize.cols);return t.difficulty=e.difficulty,t.breath=e.breath,t.reinforcements=e.reinforcements,t.playerRein=e.playerRein,t.enemyRein=e.enemyRein,t.adRewardPlayerRate=e.adRewardPlayerRate||0,t.adRewardEnemyRate=e.adRewardEnemyRate||0,t.grid=e.grid.map(s=>[...s]),t.resources=z({},e.resources),t.tickCount=e.tickCount,t.startPhase=e.startPhase,t.bonusManagerState=e.bonusManagerState||null,t}static get DEFAULT_RULES(){return[["-1,-3",-1],["-1,-2",-1],["1,2",1],["1,3",1],["0,3",1],["0,-3",-1]]}}const C={surviveGain:20,surviveLoss:-15,birthWeight:8,contactWeight:10,killBonus:40,openWeight:.14,borderWeight:0,thresholdBase:57,thresholdScale:400,supportSurvive:20};function ie(h){const{grid:e,gridSize:t,resources:s}=h,{rows:n,cols:i}=t,r=(m,u)=>m>=0&&m<n&&u>=0&&u<i,a=Array(n).fill(0).map(()=>Array(i).fill(0));for(let m=0;m<n;m++)for(let u=0;u<i;u++){let b=0;for(let w=-1;w<=1;w++)for(let E=-1;E<=1;E++)if(w||E){const p=m+w,x=u+E;r(p,x)&&(b+=e[p][x])}a[m][u]=b}const o=Math.floor(s.enemy),c=e.flat().filter(m=>m===-1).length,d=e.flat().filter(m=>m===1).length;if(o<1||c===0)return null;const l=C.thresholdBase-o*o/(c*(c+2*i))*C.thresholdScale;let y=null,_=-1/0;for(let m=0;m<n;m++)for(let u=0;u<i;u++){if(e[m][u]!==0)continue;const b=a[m][u];if(b>0)continue;const w=b-1;let E=w===-2||w===-3?1:.4,p=0;for(let f=-1;f<=1;f++)for(let g=-1;g<=1;g++){if(!(f||g))continue;const M=m+f,S=u+g;if(!r(M,S))continue;const v=a[M][S],P=v-1,A=e[M][S];if(A===-1){const $=v===-2||v===-3,G=P===-2||P===-3;if(!$&&G){p+=C.surviveGain;let k=!1;for(let R=-1;R<=1;R++)for(let T=-1;T<=1;T++){if(!(R||T))continue;const W=M+R,H=S+T;r(W,H)&&e[W][H]===1&&(k=!0)}k&&(p+=C.supportSurvive)}$&&!G&&(p+=C.surviveLoss)}A===1&&(v===2||v===3)&&!(P===2||P===3)&&(p+=C.killBonus)}for(let f=-1;f<=1;f++)for(let g=-1;g<=1;g++){if(!(f||g))continue;const M=m+f,S=u+g;!r(M,S)||e[M][S]!==0||a[M][S]-1===-3&&(p+=C.birthWeight)}let x=0;for(let f=-1;f<=1;f++)for(let g=-1;g<=1;g++){if(!(f||g))continue;const M=m+f,S=u+g;r(M,S)&&e[M][S]===1&&x++}d*5<c?p+=C.contactWeight*o*x*c/(5*d+5):p+=C.contactWeight*o*x;let O=0;for(let f=-2;f<=2;f++)for(let g=-2;g<=2;g++){if(f===0&&g===0)continue;const M=m+f,S=u+g;r(M,S)&&a[M][S]==0&&(O+=1)}const L=Math.min(5,m,n-1-m,u,i-1-u);p+=C.borderWeight*L,p*=E,p*=C.openWeight*O,p>_&&(_=p,y={r:m,c:u,score:p,survivalMultiplier:E})}return y&&y.score>=l&&y.score>0?{r:y.r,c:y.c}:null}class F{constructor(){this.soundOn=!0,this.tutorialOn=!0,this.difficulty=0,this.breath=0,this.reinforcements=0,this.speed=1,this.gridSize={rows:12,cols:18}}static fromJSON(e={}){var s,n,i,r,a,o;const t=new F;return t.soundOn=(s=e.soundOn)!=null?s:!0,t.tutorialOn=(n=e.tutorialOn)!=null?n:!0,t.difficulty=(i=Number(e.difficulty))!=null?i:0,t.breath=(r=Number(e.breath))!=null?r:0,t.reinforcements=(a=Number(e.reinforcements))!=null?a:0,t.speed=(o=Number(e.speed))!=null?o:1,e.gridSize&&typeof e.gridSize=="object"?t.gridSize={rows:Number(e.gridSize.rows)||12,cols:Number(e.gridSize.cols)||18}:t.gridSize={rows:12,cols:18},t}toJSON(){return{soundOn:this.soundOn,tutorialOn:this.tutorialOn,difficulty:this.difficulty,breath:this.breath,reinforcements:this.reinforcements,speed:this.speed,gridSize:z({},this.gridSize)}}}function N(h,e){try{const t=JSON.stringify(h.toJSON());localStorage.setItem(e,t)}catch(t){console.error("Не удалось сохранить данные:",t)}}function D(h){const e=localStorage.getItem(h);if(!e)return null;try{const t=JSON.parse(e);if(h==="game-state")return U.fromJSON(t);if(h==="game-settings")return F.fromJSON(t)}catch(t){console.error(`Не удалось загрузить ${h}:`,t)}return null}function re(h){try{localStorage.removeItem(h)}catch(e){console.error("Не удалось удалить данные:",e)}}class V{constructor(e,t,{onTick:s=()=>{},onGameOver:n=()=>{},onSound:i=()=>{}}={}){this.state=new U(e,t),this.births={},this.deaths={},this.placements={},this.killed={},this.lastReinforcementPower=0,this.onTick=s,this.onGameOver=n,this.onSound=i}setParameters(e){this.state.difficulty=e.difficulty,this.state.breath=e.breath,this.state.reinforcements=e.reinforcements}initGrid(){this.state.reset();const{rows:e,cols:t}=this.state.gridSize;for(let s=0;s<10&&s<e;s++)for(let n=t-6;n<t;n++)Math.random()<.5&&(this.state.grid[s][n]=1,this.state.grid[e-s-1][t-n-1]=-1)}setupAnimations(){this.births={},this.deaths={},this.placements={}}updateRandomCells(){const{rows:e,cols:t}=this.state.gridSize;let s=Math.floor(e*t*this.state.RANDOM_RATIO*this.state.speed+Math.random());for(;s--;){const n=Math.floor(Math.random()*e),i=Math.floor(Math.random()*t),r=this.state.grid[n][i],a=this.calcSum(n,i),o=`${r},${a}`,c=this.state.rules.get(o)||0,d=Math.floor(Math.random()+c);this.state.grid[n][i]=d;const l=this.state.tickCount;r!==0&&d===0&&(this.deaths[`${n},${i}`]=l,!this.nextSoundEvent&&this.calcEnemies(r,n,i)>0&&(this.nextSoundEvent=r>0?"death_nearby":"opp_killed")),r===0&&d!==0&&(this.births[`${n},${i}`]=l)}}recalcResources(){const{rows:e}=this.state.gridSize,{player:t,enemy:s}=this.state.countUnits(),n=Math.sin(this.state.phase),i=1+this.state.breath*n,r=1-this.state.breath*n,a=Math.pow(t,.25)*.035*Math.sqrt(e)/(1+this.state.reinforcements),o=Math.pow(s,.25)*.035*Math.sqrt(e)/(1+this.state.reinforcements),c=20*this.state.speed/1e3,d=Math.min(5,1/(1e-8+Math.sqrt(this.state.difficulty))),l=Math.sqrt(this.state.difficulty)+1e-8;this.state.resources.incomeP=a*i*d,this.state.resources.incomeE=o*r*l;const y=Math.max(Math.min(this.state.tickCount,20*e*B(this.state.tickCount,.33)),4e3),_=this.state.reinforcements,m=this.state.playerRein*150/y,u=this.state.enemyRein*150/y;this.state.resources.incomeP+=m,this.state.resources.incomeE+=u,this.state.resources.adRewardPlayerRate=this.state.resources.incomeP,this.state.resources.adRewardEnemyRate=this.state.resources.incomeE,this.state.playerRein-=this.state.playerRein*150/y*c,this.state.enemyRein-=this.state.enemyRein*150/y*c,this.state.resources.player+=this.state.resources.incomeP*c,this.state.resources.enemy+=this.state.resources.incomeE*c,this.lastReinforcementPower*=1-c;let b=m/d*.5+a,w=u/l*.5+o;const E=B(Math.min(1,(a+o)*2.5/(b+w)),.5);b*=E,w*=E;let p=Math.max(this.state.resources.player+t-this.state.resources.enemy,1),x=Math.max(this.state.resources.enemy+s-this.state.resources.player,1),O=Math.max(p+this.state.playerRein*.5,1),L=Math.max(x+this.state.enemyRein*.5,1);const f=Math.min(Math.max(1,p/L/2,x/2/O),16),g=.5/(.02*y)*B(_,.5)*B(f,.5),M=Math.max(w-b*0,0)*d/g*B(_,.5)*B(f,.2),S=Math.max(b-w*0,0)*l/g*B(_,.5)*B(f,.2);if(this.state.reinInfo={reinSecond:g,playerReinSize:M,enemyReinSize:S},Math.random()<g*c){let v=M;this.state.playerRein+=v,this.lastReinforcementPower+=v,v>=.5*e&&(v<1.5*e?this.nextSoundEvent2="rein_player_1":v<5*e?this.nextSoundEvent2="rein_player_2":this.nextSoundEvent2="rein_player_3")}if(Math.random()<g*c){let v=S;this.state.enemyRein+=v,this.lastReinforcementPower-=v,v>=.5*e&&(v<1.5*e?this.nextSoundEvent2="rein_enemy_1":v<5*e?this.nextSoundEvent2="rein_enemy_2":this.nextSoundEvent2="rein_enemy_3")}}tick(){if(this.state.tickCount+=this.state.speed,this.state.phase=this.state.startPhase+3.14*Math.log2(100+this.state.tickCount),this.updateRandomCells(),this.recalcResources(),Math.floor(this.state.tickCount%4/this.state.speed)==0)for(let e=0;e<Math.ceil(this.state.speed/4);e++){const t=ie(this.state);t&&(this.state.grid[t.r][t.c]=-1,this.placements[`${t.r},${t.c}`]={time:this.state.tickCount,type:"enemy"},this.state.resources.enemy--,this.nextSoundEvent="enemy_place")}Math.floor(this.state.tickCount%20/this.state.speed)==0&&N(this.state,"game-state"),this.onTick(this.state,{births:this.births,deaths:this.deaths,placements:this.placements})}startGameLoop(){this.state.running=!0;const e=()=>{if(!this.state.running)return;const t=performance.now();this.state.speed>0&&this.tick();const s=performance.now()-t;setTimeout(e,Math.max(0,20-s))};e()}stop(){this.state.running=!1}getWinner(){const{player:e,enemy:t}=this.state.countUnits();return e===0?"enemy":t===0?"player":null}calcSum(e,t){let s=0;for(let n=-1;n<=1;n++)for(let i=-1;i<=1;i++){if(n===0&&i===0)continue;const r=e+n,a=t+i;r>=0&&r<this.state.gridSize.rows&&a>=0&&a<this.state.gridSize.cols&&(s+=this.state.grid[r][a])}return s}calcEnemies(e,t,s){let n=0;for(let i=-1;i<=1;i++)for(let r=-1;r<=1;r++){if(i===0&&r===0)continue;const a=t+i,o=s+r;if(a>=0&&a<this.state.gridSize.rows&&o>=0&&o<this.state.gridSize.cols){const c=this.state.grid[a][o];e*c<0&&(n-=e*c)}}return n}canPlace(e,t,s){const n=e>0?this.state.resources.player:this.state.resources.enemy;return t>=0&&t<this.state.gridSize.rows&&s>=0&&s<this.state.gridSize.cols&&n>=1&&this.state.grid[t][s]===0&&this.calcSum(t,s)*e>=0}place(e,t,s){e>0?(this.state.resources.player--,this.state.grid[t][s]=1):(this.state.resources.enemy--,this.state.grid[t][s]=-1)}}class ae{constructor(e){this.renderer=e,this.SLIDER_COLORS={difficultySlider:[[0,255,0],[255,0,0],[0,0,0]],breathSlider:[[255,255,255],[142,36,170],[75,0,75]],reinforcementsSlider:[[200,200,200],[100,100,250],[0,0,120]]},this._findDOMElements(),this._bindEvents()}_findDOMElements(){this.gameScreen=document.getElementById("gameScreen"),this.gameOverScreen=document.getElementById("gameOverScreen"),this.helpOverlay=document.getElementById("helpOverlay"),this.startBtn=document.getElementById("startBtn"),this.resumeBtn=document.getElementById("resumeBtn"),this.howBtn=document.getElementById("howBtn"),this.closeHelpBtn=document.getElementById("closeHelp"),this.menuBtn=document.getElementById("menuButton"),this.overwriteModal=document.getElementById("overwriteModal"),this.confirmOverwrite=document.getElementById("overwriteConfirm"),this.cancelOverwrite=document.getElementById("overwriteCancel"),this.difficultySlider=document.getElementById("difficultySlider"),this.breathSlider=document.getElementById("breathSlider"),this.breathDisplay=document.getElementById("breathValue"),this.reinforcementsSlider=document.getElementById("reinforcementsSlider"),this.reinforcementsDisplay=document.getElementById("reinforcementsValue"),this.gridSizeInputs=document.querySelectorAll('input[name="gridSize"]'),this.gameOverMessage=document.getElementById("gameOverMessage"),this.speedButtons=document.querySelectorAll(".speed-controls button"),this.soundToggle=document.getElementById("soundToggle"),this.tutorialToggle=document.getElementById("tutorialToggle"),this.exitBtn=document.getElementById("exitBtn")}_bindEvents(){this._bindMenuButtons(),this._bindModalButtons(),this._bindGameControls()}getGameSettings(){return{difficulty:Number(this.difficultySlider.value)/100,breath:Number(this.breathSlider.value)/100,reinforcements:Number(this.reinforcementsSlider.value)/100}}getSelectedGridSize(){const e=Array.from(this.gridSizeInputs).find(n=>n.checked);if(!e)return{rows:20,cols:30};const[t,s]=e.value.split("x").map(Number);return{rows:t,cols:s}}showOverwriteModal(){this.overwriteModal.classList.remove("hidden")}hideOverwriteModal(){this.overwriteModal.classList.add("hidden")}updateResumeButton(){const e=D("game-state");this.resumeBtn.disabled=!e}showGameOver(e,t,s=null){if(this.gameOverMessage.textContent=e?t.gameOverWin:t.gameOverLose,this.gameOverScreen.classList.toggle("win",e),this.gameOverScreen.classList.toggle("lose",!e),this.gameOverScreen.hidden=!1,this.gameOverScreen.style.display="block",document.body.classList.add("overlay-active"),this.resumeBtn.disabled=!0,re("game-state"),s){let n=!1;const i=()=>I(this,null,function*(){if(!n){n=!0;try{yield s()}catch(a){console.error("🎯 ShellUI: Ошибка показа рекламы:",a)}}}),r=this.menuBtn.onclick;this.menuBtn.onclick=a=>I(this,null,function*(){a.preventDefault(),a.stopPropagation(),yield i(),r?r.call(this.menuBtn,a):(this.renderer.showScreen("start"),this.gameOverScreen.hidden=!0)})}}applyStateToUI(){var i,r,a;const e=(r=(i=this.renderer.engine)==null?void 0:i.state)!=null?r:null,t=this.renderer.settings;this.difficultySlider.value=t.difficulty*100,this.styleSlider(this.difficultySlider),this.breathSlider.value=t.breath*100,this.styleSlider(this.breathSlider),this.breathDisplay.textContent=Math.round(t.breath*100)+"%",this.reinforcementsSlider.value=t.reinforcements*100,this.styleSlider(this.reinforcementsSlider),this.reinforcementsDisplay.textContent=Math.round(t.reinforcements*100)+"%";const s=`${t.gridSize.rows}x${t.gridSize.cols}`;this.gridSizeInputs.forEach(o=>o.checked=o.value===s);const n=(a=e==null?void 0:e.speed)!=null?a:1;this.speedButtons.forEach(o=>{const c=+o.dataset.speed;o.classList.toggle("active",c===n),o.disabled=!1}),this.soundToggle.checked=t.soundOn,this.tutorialToggle.classList.toggle("active",t.tutorialOn),this._forceUpdateSliders()}initSliders(){const e=this.renderer.sliderLevels;if(!e){console.log("ShellUI: sliderLevels not yet available, will retry after i18n initialization");return}Object.keys(e).forEach(t=>{const s=this[t],n=document.getElementById(t.replace("Slider","Value")),i=document.getElementById(t.replace("Slider","Level")),r=e[t],a=()=>{if(this.styleSlider(s),n&&(n.textContent=s.value+"%"),i&&r){const o=r.find(c=>s.value>=c[0]&&s.value<=c[1]);i.textContent=o?o[2]:""}};s&&(a(),s.addEventListener("input",a))})}initSpeedControls(){this.speedButtons.forEach(t=>{t.onclick=()=>{const s=Number(t.dataset.speed),n=this.renderer.engine.state.speed;this.renderer.engine.state.speed=s,this.renderer.adManager&&(s===0&&n>0?this.renderer.adManager.pause():s>0&&n===0&&this.renderer.adManager.resume()),this.applyStateToUI()}});const e=()=>{var t;(t=this.renderer.engine)!=null&&t.state&&this.speedButtons[0].click()};document.addEventListener("visibilitychange",()=>{document.hidden&&e()}),window.addEventListener("blur",e)}initSoundToggle(){this.soundToggle.onchange=e=>{this.renderer.settings.soundOn=e.target.checked,N(this.renderer.settings,"game-settings")}}initTutorialToggle(){this.tutorialToggle.onclick=()=>{this.renderer.settings.tutorialOn=!this.renderer.settings.tutorialOn,this.tutorialToggle.classList.toggle("active",this.renderer.settings.tutorialOn),N(this.renderer.settings,"game-settings")}}initExit(){this.exitBtn=document.getElementById("exitMenu"),this.exitBtn.onclick=()=>{this.renderer.engine.stop(),this.updateResumeButton(),this.renderer.showScreen("start")}}interpolate3Colors(e,t){if(t<=.5){const s=t/.5;return e[0].map((n,i)=>Math.round(n+(e[1][i]-n)*s))}else{const s=(t-.5)/.5;return e[1].map((n,i)=>Math.round(n+(e[2][i]-n)*s))}}styleSlider(e){const t=(e.value-e.min)/(e.max-e.min)*100;e.style.setProperty("--progress",t+"%");const s=this.SLIDER_COLORS[e.id];if(!s)return;const n=(e.value-e.min)/(e.max-e.min),[i,r,a]=this.interpolate3Colors(s,n);e.style.setProperty("--fill",`rgb(${i},${r},${a})`)}_forceUpdateSliders(){this.renderer.sliderLevels&&["difficultySlider","breathSlider","reinforcementsSlider"].forEach(e=>{const t=this[e];t&&t.dispatchEvent(new Event("input"))})}_bindMenuButtons(){this.startBtn.onclick=()=>I(this,null,function*(){try{yield this.renderer._startNewGame()}catch(e){console.error("🎯 ShellUI: Ошибка запуска новой игры:",e)}}),this.resumeBtn.onclick=()=>this.renderer._resumeGame(),this.howBtn.onclick=()=>this.helpOverlay.hidden=!1,this.closeHelpBtn.onclick=()=>this.helpOverlay.hidden=!0,this.menuBtn.onclick=()=>{this.renderer.showScreen("start"),this.gameOverScreen.hidden=!0}}_bindModalButtons(){this.confirmOverwrite.onclick=()=>I(this,null,function*(){this.hideOverwriteModal();try{yield this.renderer._startNewGame(!0)}catch(e){console.error("🎯 ShellUI: Ошибка запуска новой игры с перезаписью:",e)}}),this.cancelOverwrite.onclick=()=>this.hideOverwriteModal()}_bindGameControls(){this.initSpeedControls(),this.initSoundToggle(),this.initTutorialToggle(),this.initExit()}}class oe{constructor(){this.shellUI=new ae(this),this._initDOM(),this._initConstants(),this._initSettings(),this.initRenderer(),this.shellUI.applyStateToUI(),this.shellUI.updateResumeButton(),this._bindUI(),this.showScreen("start"),this.bonusManager=null,this.bonusManagerClass=null,this.bonusManagerLoadError=!1,this._loadAdManager()}_loadAdManager(){return I(this,null,function*(){try{console.log("🔧 Renderer: Загружаем BonusManager...");const e=yield te(()=>import("./BonusManager-DdKBeQ96.js"),[],import.meta.url);this.bonusManagerClass=e.BonusManager,console.log("🔧 Renderer: BonusManager loaded successfully")}catch(e){console.warn("🔧 Renderer: BonusManager blocked or failed to load:",e),this.bonusManagerLoadError=!0}})}_canUseBonusManager(){return this.bonusManagerClass&&!this.bonusManagerLoadError}_initBonusManager(e=null,t=null){this._canUseBonusManager()?(console.log("🔧 Renderer: Создаем новый BonusManager"),this.bonusManager=new this.bonusManagerClass(e,this),this.bonusManager.loadState(t)):(console.log("🔧 Renderer: BonusManager недоступен"),this.bonusManager=null)}_showPreGameAdIfNeeded(){return I(this,null,function*(){if(this.bonusManager)try{console.log("🎯 Renderer: Проверяем необходимость показа пре-игровой рекламы"),yield this.bonusManager.showPreGameAd()}catch(e){console.error("🎯 Renderer: Ошибка показа пре-игровой рекламы:",e)}})}_initDOM(){this.startScreen=document.getElementById("startScreen"),this.gameScreen=document.getElementById("gameScreen"),this.helpOverlay=document.getElementById("helpOverlay"),this.gameOverScreen=document.getElementById("gameOverScreen"),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.playerOnField=document.getElementById("playerOnField"),this.playerReserve=document.getElementById("playerReserve"),this.playerIncome=document.getElementById("playerIncome"),this.playerAlly=document.getElementById("playerAlly"),this.enemyOnField=document.getElementById("enemyOnField"),this.enemyReserve=document.getElementById("enemyReserve"),this.enemyIncome=document.getElementById("enemyIncome"),this.enemyAlly=document.getElementById("enemyAlly"),this.gameTime=document.getElementById("gameTime"),this.timeReinforcements=document.getElementById("timeReinforcements"),this.sizeReinforcements=document.getElementById("sizeReinforcements"),this.caravanAmountsLine=document.getElementById("caravanAmountsLine"),this.i18n=JSON.parse(document.getElementById("i18n").textContent),document.addEventListener("langChanged",e=>this.applyI18n(e.detail)),this.applyI18n({lang:localStorage.getItem("lang")||"en",dict:this.i18n[localStorage.getItem("lang")||"en"]})}_initConstants(){this.cellSize=1,window.addEventListener("resize",()=>{this.initRenderer()}),this.sounds={};const e=["death_nearby","opp_killed","enemy_place","player_place","victory","defeat","rein_enemy_1","rein_enemy_2","rein_enemy_3","rein_player_1","rein_player_2","rein_player_3"];for(const t of e){const s=new Audio(`sfx/${t}.wav`);s.preload="auto",s.load(),this.sounds[t]=s}}applyI18n({lang:e,dict:t}){this.lang=e,this.sliderLevels=t.sliderLevels,this.sidebarText=t.sidebarText,this.shellUI.initSliders(),this.updateSidebarStats()}_initSettings(){const e=D("game-settings");this.settings=e||new F,e||N(this.settings,"game-settings")}initRenderer(){var c;const e=window.innerWidth*.77,t=window.innerHeight*.97;if(document.documentElement.style.fontSize=`${Math.min(e,t*1.5)/46.7}px`,!((c=this.engine)!=null&&c.state))return;const s=this.canvas;this.wrapper;const{rows:n,cols:i}=this.engine.state.gridSize;this.cellSize=Math.max(1,Math.floor(Math.min(e/i,t/n))),Math.max(3,this.cellSize*.6),s.width=i*this.cellSize,s.height=n*this.cellSize,s.style.width=`${i*this.cellSize}px`,s.style.height=`${n*this.cellSize}px`;let r=s.getContext("2d");r.font=`${Math.floor(this.cellSize*.8)}px sans-serif`,r.textAlign="center",r.textBaseline="middle",s.style.touchAction="none";let a=!1;const o=d=>{switch(d.type){case"pointerdown":a=!0,s.setPointerCapture(d.pointerId),this.doPlace(d);break;case"pointermove":if(!a)return;this.doPlace(d);break;case"pointerup":case"pointercancel":a=!1,s.releasePointerCapture(d.pointerId);break}};["pointerdown","pointermove","pointerup","pointercancel"].forEach(d=>s.addEventListener(d,o)),this.initCompass(),document.addEventListener("keydown",({key:d,target:l,preventDefault:y})=>{/^[1-5]$/.test(d)&&(l.closest("input, textarea, [contenteditable]")||this.speedButtons[+d-1].click())}),this.engine.onTick(this.engine.state,{births:this.engine.births,deaths:this.engine.deaths,placements:this.engine.placements})}doPlace(e){if(!this.engine.state.running)return;const t=this.canvas.getBoundingClientRect(),s=Math.floor((e.clientX-t.left)/this.cellSize),n=Math.floor((e.clientY-t.top)/this.cellSize);this.engine.canPlace(1,n,s)&&(this.engine.place(1,n,s),this.engine.placements[`${n},${s}`]={time:this.engine.state.tickCount,type:"player"},this.drawCells({births:this.engine.births,deaths:this.engine.deaths,placements:this.engine.placements}),this.playSound("player_place"))}drawBackground(){const{rows:e,cols:t}=this.engine.state.gridSize,s=this.cellSize;let n,i,r;this.engine.lastReinforcementPower>0?(i=Math.min(48+Math.floor(B(this.engine.lastReinforcementPower,.4)*20),100),n=Math.max(48-Math.floor(B(this.engine.lastReinforcementPower,.4)*20),0),r=Math.max(96-Math.max(n,i),0)):(n=Math.min(48+Math.floor(B(-this.engine.lastReinforcementPower,.4)*20),100),i=Math.max(48-Math.floor(B(-this.engine.lastReinforcementPower,.4)*20),0),r=Math.max(96-Math.max(n,i),0)),this.ctx.fillStyle="rgb(16,16,16)",this.ctx.fillRect(0,0,t*s,e*s),this.ctx.strokeStyle=`rgb(${n},${i},${r})`,this.ctx.lineWidth=Math.log2(2+Math.max(n-48,i-48)/4)/e*25;for(let a=s;a<t*s;a+=s)this.ctx.beginPath(),this.ctx.moveTo(a,0),this.ctx.lineTo(a,e*s),this.ctx.stroke();for(let a=s;a<e*s;a+=s)this.ctx.beginPath(),this.ctx.moveTo(0,a),this.ctx.lineTo(t*s,a),this.ctx.stroke()}_bindUI(){this.canvas.addEventListener("click",e=>this.doPlace(e))}_startNewGame(e=!1){return I(this,null,function*(){if(!e&&D("game-state")){this.shellUI.showOverwriteModal();return}this._initBonusManager(),yield this._showPreGameAdIfNeeded(),this.showScreen("game");const{rows:t,cols:s}=this.shellUI.getSelectedGridSize();this.engine=new V(t,s,{onTick:this.handleTick.bind(this),onGameOver:this.processGameOver.bind(this),onSound:this.playSound.bind(this)}),this.settings.gridSize={rows:t,cols:s};const n=this.shellUI.getGameSettings();this.settings.difficulty=n.difficulty,this.settings.breath=n.breath,this.settings.reinforcements=n.reinforcements,this.initRenderer(),this.engine.initGrid(),this.engine.setParameters(this.settings),this.engine.setupAnimations(),this.engine.startGameLoop(),this.shellUI.applyStateToUI(),N(this.settings,"game-settings"),this.bonusManager&&(this.bonusManager.gameEngine=this.engine,this.bonusManager.loadState(null))})}handleTick(e,t){this.render(t),this.bonusManager&&(this.bonusManager.update(),e.bonusManagerState=this.bonusManager.getState())}_resumeGame(){const e=D("game-state");e&&(this.engine=new V(e.gridSize.rows,e.gridSize.cols,{onTick:this.handleTick.bind(this),onGameOver:this.processGameOver.bind(this),onSound:this.playSound.bind(this)}),this.engine.state=e),this.shellUI.applyStateToUI(),this.showScreen("game"),this.initRenderer(),this.engine.setupAnimations(),this.engine.startGameLoop(),this._initBonusManager(this.engine,e==null?void 0:e.bonusManagerState)}showScreen(e){this.startScreen.style.display=e==="start"?"block":"none",this.gameScreen.style.display=e==="game"?"flex":"none",this.gameOverScreen.style.display="none"}playSound(e){if(!this.settings.soundOn)return;const t=this.sounds[e].cloneNode(!0);t.currentTime=0,t.play().catch(()=>{})}drawCells(e={}){const{births:t,deaths:s,placements:n}=e,{rows:i,cols:r}=this.engine.state.gridSize,a=this.engine.state.grid,o=this.engine.state.tickCount,c=Math.ceil(500/25),d=Math.min(this.canvas.clientWidth/r,this.canvas.clientHeight/i);this.cellSize=d;const l=this.ctx;l.textAlign="center",l.textBaseline="middle",l.font=`${Math.floor(d*.8)}px sans-serif`;const y=(u,b)=>`rgba(${u[0]},${u[1]},${u[2]},${b})`,_={1:[0,200,0],"-1":[200,0,0]};this.drawBackground();const m=this.settings.tutorialOn;for(let u=0;u<i;u++)for(let b=0;b<r;b++){const w=a[u][b],E=`${u},${b}`;let p=this.engine.calcSum(u,b)/w,x="";m?x=p:x=w===1?"●":"o";let O="#fff";w==1?(p>3&&(O="#dd9"),p<2&&(O="#9ce")):(p>3&&(O="#bb0"),p<2&&(O="#5bd"));const L=b*d+1,f=u*d+1,g=Math.max(d-2,1),M=Math.max(d-2,1),S=L+g/2,v=f+M/2;if(s!=null&&s[E]!=null){const k=s[E],R=o-k;if(R<c){const T=R/c;l.save(),l.strokeStyle=y([200,200,200],1-T*.7),l.lineWidth=2,l.beginPath(),l.arc(S,v,d/2*(.5+.5*T),0,2*Math.PI),l.stroke(),l.restore()}else delete s[E]}if(!w)continue;const P=_[w],A=l.createRadialGradient(S,v,g*.2,S,v,g*.6);A.addColorStop(0,y(P,1)),A.addColorStop(1,y(P,.2)),l.fillStyle=A,l.fillRect(L,f,g,M);const $=n[E];if($){const k=o-$.time;if(k<c){const R=1-k/c;l.save(),l.strokeStyle=y(P,R),l.lineWidth=2+4*R,l.strokeRect(L+1,f+1,g-2,M-2),l.restore()}else delete n[E]}const G=t[E];if(G!=null){const k=o-G;if(k<c){const R=k/c;l.save(),l.strokeStyle=y(P,1-R),l.lineWidth=2*(1-R)+1,l.beginPath(),l.arc(S,v,d/2*(.3+.7*R),0,2*Math.PI),l.stroke(),l.restore(),l.save(),l.globalAlpha=.5+.5*R,l.translate(S,v);const T=.6+.4*R;l.scale(T,T),l.fillStyle=O,l.fillText(x,0,0),l.restore()}else delete t[E],l.fillStyle=O,l.fillText(x,S,v)}else l.fillStyle=O,l.fillText(x,S,v)}}showtime(){const e=Math.floor(this.engine.state.tickCount*.02),t=Math.floor(e/3600).toString().padStart(2,"0"),s=Math.floor(e%3600/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");return`${t}:${s}:${n}`}updateSidebarStats(){var a,o;if(!((a=this.engine)!=null&&a.state))return;const{player:e,enemy:t}=this.engine.state.countUnits(),s=this.engine.state.playerRein,n=this.engine.state.enemyRein,i=this.engine.state.resources;this.gameTime;function r(c,d,l,y){c.innerHTML=`
      <span class="stat-line">
        <span class="stat-label">${d}</span>
        <span class="stat-value">${l}</span>
      </span>`}if(this.gameTime.innerHTML=`
    <span class="stat-line">
      <span class="stat-label">${this.showtime()} </span>
    </span>
  `,r(playerOnField,this.sidebarText.Fld,e),r(playerReserve,this.sidebarText.Res,Math.floor(i.player)),r(playerIncome,this.sidebarText.Income,i.incomeP.toFixed(2)),r(playerAlly,this.sidebarText.Ally,s.toFixed(0)),r(enemyOnField,this.sidebarText.Fld,t),r(enemyReserve,this.sidebarText.Res,Math.floor(i.enemy)),r(enemyIncome,this.sidebarText.Income,i.incomeE.toFixed(2)),r(enemyAlly,this.sidebarText.Ally,n.toFixed(0)),(o=this.engine.state)!=null&&o.reinInfo){const c=this.engine.state.reinInfo;this.engine.state.reinforcements>0?(this.timeReinforcements.innerHTML=`
      <span class="stat-line">
        <span class="stat-label">${this.sidebarText.avgTime} </span>
        <span class="stat-value">${Math.floor(1/c.reinSecond)}</span>
        <span class="stat-label"> ${this.sidebarText.s}</span>
      </span>
    `,this.sizeReinforcements.innerHTML=`
      <span class="stat-line">
        <span class="stat-label">${this.sidebarText.You}</span>
        <span class="stat-value">${Math.floor(c.playerReinSize)}</span>
        <span class="stat-label"> ${this.sidebarText.Ai}</span>
        <span class="stat-value">${Math.floor(c.enemyReinSize)}</span>
      </span>
    `):(r(this.sizeReinforcements,"       -------    ",""),r(this.timeReinforcements,"",""))}this._updateCaravanStats()}_updateCaravanStats(){const e=this.bonusManager?Math.floor(this.bonusManager.adState.playerCaravanAmount):0,t=this.bonusManager?Math.floor(this.bonusManager.adState.enemyCaravanAmount):0;this.caravanAmountsLine&&(this.caravanAmountsLine.innerHTML=`
      <span class="stat-line">
        <span class="stat-label">${this.sidebarText.You}</span>
        <span class="stat-value" id="playerCaravanAmount">${e}</span>
        <span class="stat-label"> ${this.sidebarText.Ai}</span>
        <span class="stat-value" id="enemyCaravanAmount">${t}</span>
      </span>
    `)}render(e={}){if(this.drawCells(e),this.drawCompass(this.engine.state.phase),this.updateSidebarStats(),this.engine.nextSoundEvent&&(this.playSound(this.engine.nextSoundEvent),this.engine.nextSoundEvent=null),this.engine.nextSoundEvent2&&(this.playSound(this.engine.nextSoundEvent2),this.engine.nextSoundEvent2=null),this.engine.state.running){let t=this.engine.getWinner();t&&this.processGameOver(t).catch(s=>{console.error("🎯 Renderer: Ошибка в processGameOver:",s)})}}processGameOver(e){return I(this,null,function*(){const t=this.engine.state;t.running=!1,this.engine.stop();const s=e=="player",n=this.bonusManager?()=>I(this,null,function*(){try{console.log("🎯 Renderer: Показываем пост-игровую рекламу по callback"),yield this.bonusManager.showPostGameAd(s)}catch(i){console.error("🎯 Renderer: Ошибка показа пост-игровой рекламы:",i)}this.bonusManager=null}):null;this.shellUI.showGameOver(s,this.sidebarText,n),this.playSound(s?"victory":"defeat")})}initCompass(){this.compassCanvas=document.getElementById("compassCanvas"),this.compassCtx=this.compassCanvas.getContext("2d"),this.centerX=this.compassCanvas.width/2,this.centerY=this.compassCanvas.height/2,this.compassR=Math.min(this.centerX,this.centerY),this.ringR=this.compassR*.96;const e=this.compassCtx.createConicGradient(0,this.centerX,this.centerY);e.addColorStop(0,"#885"),e.addColorStop(.25,"#00c853"),e.addColorStop(.5,"#885"),e.addColorStop(.75,"#d50000"),e.addColorStop(1,"#885"),this.compassGradient=e}drawCompass(e){const t=this.compassCtx,s=this.compassR,n=this.ringR,i=this.centerX,r=this.centerY;t.clearRect(0,0,this.compassCanvas.width,this.compassCanvas.height),t.beginPath(),t.arc(i,r,n,0,2*Math.PI),t.lineWidth=8,t.strokeStyle=this.compassGradient,t.stroke();const a=this.engine.state.breath*.9*s,o=i+a*Math.cos(e),c=r+a*Math.sin(e);t.beginPath(),t.moveTo(i,r),t.lineTo(o,c),t.lineWidth=4,t.strokeStyle="#fff",t.stroke(),t.beginPath(),t.arc(i,r,4,0,2*Math.PI),t.fillStyle="#fff",t.fill()}}document.addEventListener("DOMContentLoaded",()=>{console.log("CellFront Game: Styles loaded and DOM ready")});function le(){return I(this,null,function*(){try{const h=yield fetch("./start-screen.html");if(!h.ok)throw new Error(`Не удалось загрузить start-screen.html: ${h.status}`);const e=yield h.text(),t=document.getElementById("startScreenBlock");if(!t){console.error('Не нашли <div id="startScreenBlock">, куда вставлять start-screen');return}t.insertAdjacentHTML("beforebegin",e)}catch(h){console.error(h)}})}function ce(){return I(this,null,function*(){try{const h=yield fetch("./overlays.html");if(!h.ok)throw new Error(`Не удалось загрузить overlays.html: ${h.status}`);const e=yield h.text();document.body.insertAdjacentHTML("beforeend",e)}catch(h){console.error(h)}})}function he(){return I(this,null,function*(){try{yield document.documentElement.requestFullscreen()}catch(e){}try{yield screen.orientation.lock("landscape")}catch(e){}const h=document.getElementById("launchOverlay");h&&h.remove(),window.scrollTo(0,0),document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",setTimeout(()=>{new oe},100)})}function de(){const h=Array.from(document.querySelectorAll("[data-en]")),e=["difficultySlider","breathSlider","reinforcementsSlider"];function t(){e.forEach(r=>{const a=document.getElementById(r);a&&a.dispatchEvent(new Event("input"))})}function s(r="en"){document.documentElement.lang=r,localStorage.lang=r,h.forEach(o=>{const c=o.dataset[r];c!==void 0&&(o.tagName==="INPUT"&&"placeholder"in o?o.placeholder=c:o.innerHTML=c,o.dataset[r+"Tip"]&&(o.dataset.tip=o.dataset[r+"Tip"],o.removeAttribute("title")))});const a=JSON.parse(document.getElementById("i18n").textContent)[r];document.dispatchEvent(new CustomEvent("langChanged",{detail:{lang:r,dict:a}})),t()}const n=localStorage.lang||(navigator.language&&navigator.language.startsWith("ru")?"ru":"en"),i=document.getElementById("langSwitch");i&&(i.value=n,s(n),i.addEventListener("change",r=>s(r.target.value)))}function ue(){return I(this,null,function*(){yield ce(),yield le();const h=document.getElementById("launchBtn");h?h.addEventListener("click",he,{once:!0}):console.warn("launchBtn не найден: проверьте start-screen.html"),de()})}ue();
